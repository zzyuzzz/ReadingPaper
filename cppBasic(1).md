# C++ 常量表达式和编译时优化

### as-if 规则

在C++中，编译器有很大的余地来优化程序as-if规则表示，编译器可以按照自己的方式修改程序，以生成更优化的代码，只要这些修改不影响程序的“可观察行为”。

编译器如何优化给定程序的确切方式取决于编译器本身。但是，我们可以采取一些措施来帮助编译器更好地优化。

### 一个可以优化的例子

```c++
#include <iostream>

int main(){
    int x{3 + 7}
    std::cout << x << std::endl;
    return 0;
}
```
程序的输出非常简单：
```
7
```
如果这个程序完全按照它编写的方式编译（没有优化），编译器生成的可执行文件，在运行时计算$3+4$的结果。如果程序执行一百万次，则$3+4$将被计算一百万次，结果值$7$将产生一百万次。

因为$3+4$的结果永远不会改变，所以每次运行程序时重新计算这个结果是浪费的。

### 表达式的编译时(compile-time)计算

现代 C++ 编译器能够在编译时计算一些表达式。发生这种情况时，编译器可以用表达式的结果替换表达式。
例如，编译器可以将上述示例优化为：
```c++
#include <iostream>

int main()
{
	int x { 7 };
	std::cout << x << std::endl;
	return 0;
}
```

### 常量表达式
常量表达式是仅包含编译时常量和支持编译时计算的运算符/函数的表达式。

**编译时常量**：  
+ 字面值。比如5，1.2
+ constexpr 变量
+ 非类型模板参数
+ 枚举
+ 具有常量表达式初始值设定项的 const 整数变量  

不是编译时常量的 Const 变量有时称为运行时常量。运行时常量不能在常量表达式中使用。

**支持编译时计算的最常见运算符和函数类型包括：**

+ 算数运算符
+ constexpr和consteval函数


